# agents/formatter_agent.py
# (V2.1 - Upgraded based on original logic)

import google.generativeai as genai
from typing import Dict, Any

class FormatterAgent:
    """
    Agent à¸—à¸µà¹ˆà¸—à¸³à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™ "à¸šà¸£à¸£à¸“à¸²à¸˜à¸´à¸à¸²à¸£" à¹à¸¥à¸° "à¸™à¸±à¸à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸š" (Typesetter)
    à¸£à¸±à¸šà¸œà¸´à¸”à¸Šà¸­à¸šà¸à¸²à¸£à¸‚à¸±à¸”à¹€à¸à¸¥à¸²à¸„à¸³à¸•à¸­à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸¡à¸µà¸£à¸¹à¸›à¹à¸šà¸šà¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™ à¸ªà¸§à¸¢à¸‡à¸²à¸¡ à¹à¸¥à¸°à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢
    """
    def __init__(self, key_manager, model_name: str, persona_prompt: str):
        """
        à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™à¹‚à¸”à¸¢à¸£à¸±à¸šà¸—à¸£à¸±à¸à¸¢à¸²à¸à¸£à¸—à¸µà¹ˆà¸ˆà¸³à¹€à¸›à¹‡à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸‚à¹‰à¸²à¸¡à¸²
        """
        self.key_manager = key_manager
        self.model_name = model_name
        
        self.formatting_prompt_template = persona_prompt + """
**à¸ à¸²à¸£à¸à¸´à¸ˆ: à¸šà¸£à¸£à¸“à¸²à¸˜à¸´à¸à¸²à¸£à¹à¸¥à¸°à¸™à¸±à¸à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸š (Editor & Typesetter)**

à¸„à¸¸à¸“à¸„à¸·à¸­ "à¹€à¸Ÿà¸´à¸‡" à¹ƒà¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢ à¸ à¸²à¸£à¸à¸´à¸ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­à¸à¸²à¸£à¸™à¸³ "à¸šà¸—à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‰à¸šà¸±à¸šà¸£à¹ˆà¸²à¸‡" à¸—à¸µà¹ˆà¸—à¸µà¸¡à¸‡à¸²à¸™à¸ªà¸£à¹‰à¸²à¸‡à¸‚à¸¶à¹‰à¸™ à¸¡à¸²à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸”à¹‰à¸§à¸¢ Markdown à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸­à¹ˆà¸²à¸™à¸‡à¹ˆà¸²à¸¢à¹à¸¥à¸°à¸ªà¸§à¸¢à¸‡à¸²à¸¡à¸—à¸µà¹ˆà¸ªà¸¸à¸” à¹‚à¸”à¸¢à¸­à¹‰à¸²à¸‡à¸­à¸´à¸‡à¸ˆà¸²à¸ "à¸„à¸³à¸–à¸²à¸¡à¸”à¸±à¹‰à¸‡à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰" à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸„à¸³à¸•à¸­à¸šà¸ªà¸¸à¸”à¸—à¹‰à¸²à¸¢à¸¢à¸±à¸‡à¸„à¸‡à¸•à¸­à¸šà¹‚à¸ˆà¸—à¸¢à¹Œ

**à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸£à¸°à¸à¸­à¸š:**
- **à¸„à¸³à¸–à¸²à¸¡à¸”à¸±à¹‰à¸‡à¹€à¸”à¸´à¸¡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰:** {original_query}
- **à¸šà¸—à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸‰à¸šà¸±à¸šà¸£à¹ˆà¸²à¸‡ (à¸«à¹‰à¸²à¸¡à¸•à¸±à¸”à¸—à¸­à¸™):**
---
{draft_to_review}
---

**à¸à¸à¹€à¸«à¸¥à¹‡à¸à¸‚à¹‰à¸­ 2 (à¸ªà¸³à¸„à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”):**
**à¸«à¹‰à¸²à¸¡à¸ªà¸£à¸¸à¸›à¸«à¸£à¸·à¸­à¸•à¸±à¸”à¸—à¸­à¸™à¹€à¸™à¸·à¹‰à¸­à¸«à¸²à¹‚à¸”à¸¢à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” (DO NOT SUMMARIZE OR SHORTEN THE CONTENT)** à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸£à¸±à¸à¸©à¸²à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹à¸¥à¸°à¹ƒà¸ˆà¸„à¸§à¸²à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡à¸•à¹‰à¸™à¸‰à¸šà¸±à¸šà¹„à¸§à¹‰ 100%
**à¹€à¸Šà¹‡à¸„à¸„à¸³à¸•à¸­à¸šà¹ƒà¸«à¹‰à¸”à¸µà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ à¸«à¹‰à¸²à¸¡à¹ƒà¸«à¹‰à¸¡à¸µà¸ à¸²à¸©à¸²à¸­à¸·à¹ˆà¸™à¸«à¸¥à¸¸à¸”à¹„à¸›à¹€à¸”à¹‡à¸”à¸‚à¸²à¸”à¸¢à¸à¹€à¸§à¹‰à¸™à¸„à¸³à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¹€à¸‰à¸à¸²à¸° à¹à¸¥à¸° à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸¡à¸²à¸ˆà¸²à¸à¹‚à¸„à¹‰à¸”**

**à¸à¸à¸à¸²à¸£à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸š:**
1.  **à¸ˆà¸±à¸”à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡:** à¹ƒà¸Šà¹‰ Markdown à¹€à¸Šà¹ˆà¸™ **à¸«à¸±à¸§à¸‚à¹‰à¸­à¸«à¸¥à¸±à¸** à¹à¸¥à¸° * à¸£à¸²à¸¢à¸à¸²à¸£à¸¢à¹ˆà¸­à¸¢ à¹€à¸à¸·à¹ˆà¸­à¹à¸šà¹ˆà¸‡à¸›à¸£à¸°à¹€à¸”à¹‡à¸™à¹ƒà¸«à¹‰à¸Šà¸±à¸”à¹€à¸ˆà¸™
2.  **à¸›à¸£à¸±à¸šà¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²:** à¸•à¸±à¸”à¹à¸šà¹ˆà¸‡à¸¢à¹ˆà¸­à¸«à¸™à¹‰à¸²à¸¢à¸²à¸§à¹† à¹ƒà¸«à¹‰à¸ªà¸±à¹‰à¸™à¸¥à¸‡à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸ªà¸šà¸²à¸¢à¸•à¸²à¹ƒà¸™à¸à¸²à¸£à¸­à¹ˆà¸²à¸™
3.  **à¸„à¸‡à¸šà¸¸à¸„à¸¥à¸´à¸:** à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹ƒà¸«à¹‰à¹à¸™à¹ˆà¹ƒà¸ˆà¸§à¹ˆà¸²à¸ à¸²à¸©à¸²à¸¢à¸±à¸‡à¸„à¸‡à¸„à¸§à¸²à¸¡à¸ªà¸¸à¸‚à¸¸à¸¡à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¹€à¸«à¸•à¸¸à¸œà¸¥à¸•à¸²à¸¡à¸šà¸¸à¸„à¸¥à¸´à¸à¸‚à¸­à¸‡ "à¹€à¸Ÿà¸´à¸‡"
4.  **à¸—à¸³à¹ƒà¸«à¹‰à¸”à¸¹à¹€à¸›à¹‡à¸™à¸˜à¸£à¸£à¸¡à¸Šà¸²à¸•à¸´:** à¸—à¸³à¹ƒà¸«à¹‰à¸”à¸¹à¹€à¸«à¸¡à¸·à¸­à¸™à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¸ˆà¸£à¸´à¸‡à¹† à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¹à¸„à¹ˆ AI
5.  **à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸­à¸˜à¸´à¸šà¸²à¸¢:** à¸«à¹‰à¸²à¸¡à¹ƒà¸ªà¹ˆà¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸«à¸£à¸·à¸­à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸­à¸·à¹ˆà¸™à¹† à¸™à¸­à¸à¹€à¸«à¸™à¸·à¸­à¸ˆà¸²à¸ Markdown à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¹à¸¥à¹‰à¸§

**à¸‰à¸šà¸±à¸šà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œà¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸£à¸¹à¸›à¹à¸šà¸šà¹à¸¥à¹‰à¸§ (à¹‚à¸”à¸¢ à¹€à¸Ÿà¸´à¸‡):**
"""

    def handle(self, synthesis_order: Dict[str, Any]) -> str:
        """
        à¸£à¸±à¸š "à¹à¸Ÿà¹‰à¸¡à¸‡à¸²à¸™à¸šà¸£à¸£à¸“à¸²à¸˜à¸´à¸à¸²à¸£" (synthesis_order) à¸ˆà¸²à¸ Dispatcher à¸¡à¸²à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥
        """
        raw_draft = synthesis_order.get("draft_to_review", "")
        if not raw_draft or not isinstance(raw_draft, str):
            return ""

        original_query = synthesis_order.get("original_query", "(à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸)")

        print("âœï¸ [Formatter Agent] Requesting a key for final typesetting...")
        api_key = self.key_manager.get_key()
        if not api_key:
            print("âš ï¸ FormatterAgent: No API keys available. Returning raw draft.")
            return raw_draft

        try:
            genai.configure(api_key=api_key)
            model = genai.GenerativeModel(self.model_name)
            
            prompt = self.formatting_prompt_template.format(
                original_query=original_query,
                draft_to_review=raw_draft
            )
            response = model.generate_content(prompt)
            return response.text.strip()
            
        except Exception as e:
            error_str = str(e).lower()
            if "429" in error_str:
                print(f"ğŸŸ¡ Formatter Agent: Key '...{api_key[-4:]}' hit rate limit.")
                self.key_manager.report_failure(api_key)
                print("   -> Retrying with the next available key...")
                return self.handle(synthesis_order)
            else:
                print(f"âŒ An unexpected error occurred in Formatter Agent: {e}")
                return raw_draft